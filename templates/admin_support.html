{% extends "base.html" %}

{% block content %}
<div class="card">
    <h1>🛠️ Admin Support Center</h1>
    <p>Manage user support requests and system operations</p>
</div>

<!-- Support Statistics -->
<div class="card">
    <h2>📊 Support Statistics</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
        <div style="background: rgba(220, 53, 69, 0.1); padding: 1rem; border-radius: 8px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #dc3545;">{{ pending_escalations|length }}</div>
            <div>Pending Escalations</div>
        </div>
        <div style="background: rgba(255, 193, 7, 0.1); padding: 1rem; border-radius: 8px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #ffc107;">{{ active_chats|length }}</div>
            <div>Active Support Chats</div>
        </div>
        <div style="background: rgba(40, 167, 69, 0.1); padding: 1rem; border-radius: 8px; text-align: center;">
            <div style="font-size: 2rem; font-weight: bold; color: #28a745;">{{ resolved_today }}</div>
            <div>Resolved Today</div>
        </div>
    </div>
</div>

<!-- Pending Escalations -->
<div class="card">
    <h2>🚨 Pending User Escalations</h2>
    {% if pending_escalations %}
        {% for escalation in pending_escalations %}
        <div class="match-card" style="border-left: 4px solid #dc3545; margin-bottom: 1rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <div>
                    <strong>{{ escalation[2] }}</strong> - User ID: {{ escalation[1] }}
                    <br><small>{{ escalation[6] }}</small>
                </div>
                <div>
                    <span style="background: #dc3545; color: white; padding: 0.25rem 0.5rem; border-radius: 12px; font-size: 0.8rem;">
                        {{ escalation[4].upper() }}
                    </span>
                </div>
            </div>
            
            <div style="background: rgba(255,255,255,0.1); padding: 1rem; border-radius: 8px; margin-bottom: 1rem;">
                <strong>User Issue:</strong><br>
                {{ escalation[3] }}
            </div>
            
            <div style="display: flex; gap: 0.5rem;">
                <button onclick="respondToUser('{{ escalation[0] }}', '{{ escalation[2] }}')" class="btn btn-success">
                    💬 Respond to User
                </button>
                <button onclick="markResolved('{{ escalation[0] }}')" class="btn btn-secondary">
                    ✅ Mark Resolved
                </button>
                <button onclick="escalateToPhone('{{ escalation[2] }}')" class="btn btn-warning">
                    📞 Call User
                </button>
            </div>
        </div>
        {% endfor %}
    {% else %}
        <p>No pending escalations. Great job! 🎉</p>
    {% endif %}
</div>

<!-- Quick Admin Actions -->
<div class="card">
    <h2>⚡ Quick Admin Actions</h2>
    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
        <div style="background: rgba(23, 162, 184, 0.1); padding: 1.5rem; border-radius: 8px;">
            <h3>💰 Financial Support</h3>
            <button onclick="showUserBalance()" class="btn btn-primary">Check User Balance</button>
            <button onclick="adjustBalance()" class="btn btn-warning">Adjust Balance</button>
            <button onclick="refundUser()" class="btn btn-success">Process Refund</button>
        </div>
        
        <div style="background: rgba(40, 167, 69, 0.1); padding: 1.5rem; border-radius: 8px;">
            <h3>🎮 Game Support</h3>
            <button onclick="resolveMatch()" class="btn btn-primary">Resolve Match Dispute</button>
            <button onclick="cancelMatch()" class="btn btn-danger">Cancel Match</button>
            <button onclick="createTournament()" class="btn btn-success">Create Tournament</button>
        </div>
        
        <div style="background: rgba(255, 193, 7, 0.1); padding: 1.5rem; border-radius: 8px;">
            <h3>👤 User Management</h3>
            <button onclick="banUser()" class="btn btn-danger">Ban User</button>
            <button onclick="unbanUser()" class="btn btn-success">Unban User</button>
            <button onclick="resetPassword()" class="btn btn-warning">Reset Password</button>
        </div>
    </div>
</div>

<!-- Admin Response Modal -->
<div id="responseModal" class="modal">
    <div class="modal-content">
        <span class="close" onclick="closeModal()">&times;</span>
        <h2>Respond to User</h2>
        <div id="userInfo"></div>
        <textarea id="adminResponse" placeholder="Type your response to the user..." 
                  style="width: 100%; height: 150px; margin: 1rem 0; padding: 1rem; border-radius: 8px; border: 1px solid #ddd;"></textarea>
        <div style="display: flex; gap: 1rem;">
            <button onclick="sendResponse()" class="btn btn-success">Send Response</button>
            <button onclick="sendAndCall()" class="btn btn-warning">Send & Schedule Call</button>
            <button onclick="closeModal()" class="btn btn-secondary">Cancel</button>
        </div>
    </div>
</div>

<script>
let currentEscalationId = null;
let currentUsername = null;

function respondToUser(escalationId, username) {
    currentEscalationId = escalationId;
    currentUsername = username;
    document.getElementById('userInfo').innerHTML = `<strong>Responding to:</strong> ${username}`;
    document.getElementById('responseModal').style.display = 'block';
}

function sendResponse() {
    const response = document.getElementById('adminResponse').value;
    if (!response.trim()) {
        alert('Please enter a response');
        return;
    }
    
    fetch('/admin/respond_support', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            escalation_id: currentEscalationId,
            response: response
        })
    }).then(() => {
        alert('Response sent to user!');
        closeModal();
        location.reload();
    });
}

function markResolved(escalationId) {
    if (confirm('Mark this issue as resolved?')) {
        fetch('/admin/resolve_support', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({escalation_id: escalationId})
        }).then(() => {
            alert('Issue marked as resolved!');
            location.reload();
        });
    }
}

function closeModal() {
    document.getElementById('responseModal').style.display = 'none';
    document.getElementById('adminResponse').value = '';
}

function showUserBalance() {
    const username = prompt('Enter username to check balance:');
    if (username) {
        window.open(`/admin/user_details/${username}`, '_blank');
    }
}

function adjustBalance() {
    const username = prompt('Enter username:');
    const amount = prompt('Enter amount to add/subtract (use - for subtract):');
    if (username && amount) {
        fetch('/admin/adjust_balance', {
            method: 'POST',
            headers: {'Content-Type': 'application/json'},
            body: JSON.stringify({username: username, amount: parseFloat(amount)})
        }).then(() => {
            alert('Balance adjusted successfully!');
        });
    }
}

// Auto-refresh every 30 seconds for new escalations
setInterval(() => {
    location.reload();
}, 30000);
</script>
{% endblock %}